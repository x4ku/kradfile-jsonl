#!/usr/bin/env python3
import json
import logging
import os
from pathlib import Path


logging.basicConfig(
    level=os.getenv('LOG_LEVEL', 'INFO'),
    format=(
        '[%(levelname)s] %(asctime)s '
        '(%(funcName)s:%(lineno)s) '
        '%(message)s'
    )
)
logger = logging.getLogger(__name__)


def main():
    data_dir = Path('data')
    input_path1 = str(data_dir / 'kradfile')
    input_path2 = str(data_dir / 'kradfile2')
    output_path = str(data_dir / 'kradfile.jsonl')
    convert_kradfile([input_path1, input_path2], output_path)


def convert_kradfile(input_paths, output_path):
    logger.info('Converting KRADFILE ...')
    stream = raw_kradfile_stream(input_paths)
    stream = kradfile_record_adapter(stream)
    stream = stream_writer(stream, output_path)
    read_stream(stream)
    logger.info('Converted KRADFILE')


def raw_kradfile_stream(paths):
    for path in paths:
        with open(path) as file:
            for line in file:
                line = line.strip()
                if line.startswith('#'):
                    continue
                yield line


def kradfile_record_adapter(stream):
    for raw in stream:
        yield build_kradfile_record(raw)


def build_kradfile_record(raw):
    return [raw[0], raw[4:].split(' ')]


def stream_writer(stream, path, write=None):
    write = write or write_json
    with open(path, 'w') as file:
        for record in stream:
            write(record, file)
            yield record


def write_json(obj, file):
    file.write(f'{json.dumps(obj, ensure_ascii=False)}\n')


def read_stream(stream):
    for record in stream:
        pass


if __name__ == '__main__':
    main()
